{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="dashboard-container">

  <!-- LEFT: Visual Core -->
  <section class="dashboard-left">
    <div class="spline-wrapper">
      <iframe 
        src="https://my.spline.design/genkubgreetingrobot-ljUcpTAZJbKIAq7d98imBlOZ/"
        allow="autoplay; fullscreen" 
        loading="lazy">
      </iframe>
    </div>
    <h1 class="welcome-title">Welcome, {{ user.username }}!</h1>
    <p class="welcome-sub">Ready to perfect your resume? Let's get started.</p>
  </section>

  <!-- RIGHT: Control Panel -->
  <section class="dashboard-right">

    <!-- Analyze Resume -->
    <h2 class="section-heading">Analyze New Resume</h2>
    <form method="post" enctype="multipart/form-data" class="analyze-form">
      {% csrf_token %}
      {% if form.non_field_errors %}
        <div class="form-errors">{{ form.non_field_errors.as_text }}</div>
      {% endif %}
      <div class="form-group">
  <label for="resume_file">Upload Your Resume</label>
  <div class="drop-zone" id="drop-zone">
    <input type="file" id="resume_file" name="resume_file" accept=".doc,.docx,.txt,.pdf,.jpg,.jpeg,.png,.tiff" />
    <div class="drop-zone-label">
      <strong>Drag & drop</strong> or <strong>Choose File</strong>
    </div>
    <div id="file-name" class="drop-text">No file chosen</div>
  </div>
  </div>

      <div class="form-group">
        <label for="id_job_role">Select a Saved Role</label>
        <select name="job_role" id="id_job_role">
          <option value="" selected>-- Select a Job Role --</option>
          {% for category, roles in grouped_roles.items %}
            <optgroup label="{{ category }}">
              {% for role in roles %}
                <option value="{{ role.id }}">{{ role.name }}</option>
              {% endfor %}
            </optgroup>
          {% endfor %}
        </select>
      </div>
      <div class="form-separator"><span>OR</span></div>
      <div class="form-group">
        <label for="{{ form.custom_job_description.id_for_label }}">Or Paste Job Description</label>
        {{ form.custom_job_description }}
      </div>

      <button type="submit" class="btn-submit">Analyze Now</button>
    </form>

    <!-- History -->
    <h4 class="section-subheading">Analysis History</h4>
    <button id="toggleHistoryBtn" class="text-white fw-semibold mb-3 d-flex align-items-center gap-2 bg-transparent border-0">
      <span>Show Analysis History</span>
      <svg id="chevronIcon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-chevron-down transition" viewBox="0 0 16 16">
        <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
      </svg>
    </button>

    <!-- Collapsible History Section -->
    <div id="historyContainer" class="dashboard-history d-none">
      {% if past_results %}
        {% for result in past_results %}
          <div class="history-card">
            <div>
              <strong>{{ result.get_job_title }}</strong>
              <p class="history-date">Analyzed: {{ result.analyzed_at|date:"M d, Y" }}</p>
            </div>
            <a href="{% url 'results' result.id %}" class="btn-small">View</a>
          </div>
        {% endfor %}
      {% else %}
        <div class="empty-state">
          <img src="{% static 'images/empty-icon.svg' %}" alt="No History" />
          <p>No past analyses yet.<br>Upload a resume to begin.</p>
        </div>
      {% endif %}
    </div>

  </section>
</div>
{% endblock %}

{% block scripts %}
<script>
  // === Resume Upload Drag & Drop ===
 const dropZone = document.getElementById('drop-zone');
  const fileInput = document.getElementById('resume_file');
  const fileNameDisplay = document.getElementById('file-name');

  fileInput.addEventListener('change', () => {
    const file = fileInput.files[0];
    fileNameDisplay.textContent = file ? file.name : 'No file chosen';
  });

  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('dragover');
  });

  dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('dragover');
  });

  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('dragover');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      fileInput.files = files;
      fileNameDisplay.textContent = files[0].name;
    }
  });

  // === Toggle History Panel ===
  const toggleBtn = document.getElementById('toggleHistoryBtn');
  const historyContainer = document.getElementById('historyContainer');
  const chevronIcon = document.getElementById('chevronIcon');
  let isVisible = false;

  toggleBtn.addEventListener('click', () => {
    isVisible = !isVisible;
    historyContainer.classList.toggle('d-none', !isVisible);
    toggleBtn.querySelector('span').textContent = isVisible ? 'Hide Analysis History' : 'Show Analysis History';
    chevronIcon.style.transform = isVisible ? 'rotate(180deg)' : 'rotate(0deg)';
  });
</script>

{% endblock %}
